---
- name: Get architecture
  shell:
    dpkg --print-architecture
  register: architecture

- name: Check if Helm GPG key exists on host
  stat:
    path: "{{ helm_gpg_key }}"
  register: key

- name: Add Helm GPG key
  shell:
    curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee {{ helm_gpg_key }} > /dev/null
  when: key.stat.exists == False

- name: Add Helm APT repository
  copy:
    content: |
      deb [arch={{ architecture.stdout }} signed-by={{ helm_gpg_key }}] https://baltocdn.com/helm/stable/debian/ all main
    dest: /etc/apt/sources.list.d/helm-stable-debian.list
    mode: 0644
    owner: root
    group: root

- name: Install Helm
  apt:
    update_cache: yes
    name: helm
    state: present

- name: Install python3-kubernetes package
  apt:
    name: python3-kubernetes
    state: present

- name: Add Rancher Stable Helm repository
  kubernetes.core.helm_repository:
    name: rancher-stable
    repo_url: "{{ rancher_helm_chart }}"

- name: Create k8s namespace cattle-system
  kubernetes.core.k8s:
    name: cattle-system
    api_version: v1
    kind: Namespace
    state: present
